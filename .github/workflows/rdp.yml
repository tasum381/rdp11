name: Free RDP - Fixed Nov 2025

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Latest Ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip

      - name: Extract Ngrok Properly
        run: |
          Expand-Archive ngrok.zip -DestinationPath . -Force
          Move-Item -Path "ngrok/ngrok.exe" -Destination "ngrok.exe" -Force   # â† THIS FIXES THE PATH ERROR

      - name: Verify Ngrok Exists
        run: |
          if (!(Test-Path "ngrok.exe")) { echo "NGROK.EXE NOT FOUND - EXTRACTION FAILED"; exit 1 }
          echo "ngrok.exe found - good to go"

      - name: Auth Ngrok (This Will Work Now)
        run: |
          ./ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: Set Password
        run: |
          net user administrator Abc123456 /active:yes
          echo "Username: administrator"
          echo "Password: Abc123456"

      - name: Start Ngrok Tunnel
        run: |
          ./ngrok.exe tcp 3389 --log=stdout > ngrok.log 2>&1 &

      - name: Wait & Show RDP Address
        run: |
          Start-Sleep -Seconds 20
          $tunnel = Invoke-WebRequest http://localhost:4040/api/tunnels -UseBasicParsing | ConvertFrom-Json
          $addr = $tunnel.tunnels | Where-Object proto -eq tcp | Select-Object -First 1 -ExpandProperty public_url
          echo "==================================================================="
          echo "RDP READY - CONNECT NOW!"
          echo "Address: $($addr.Replace('tcp://',''))"
          echo "Username: administrator"
          echo "Password: Abc123456"
          echo "==================================================================="
          echo "Tunnel URL: $addr"

      - name: Keep Alive Forever
        run: |
          echo "Cracking session active - enjoy your free beast RDP"
          while($true) { Start-Sleep -Seconds 3600 }
